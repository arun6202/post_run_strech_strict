<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Elite Post-Run Stretch</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --surface: #1e293b;
            --primary-accent: #38bdf8; /* A bright sky blue */
            --primary-text: #f8fafc;
            --secondary-text: #94a3b8;
            --border-color: #334155;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
            --transition: all 0.3s ease-in-out;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-dark);
            color: var(--primary-text);
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            position: relative;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-text);
        }

        .header-controls {
            position: absolute;
            right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .test-btn {
            background-color: var(--primary-accent);
            color: var(--bg-dark);
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .test-btn:hover {
            opacity: 0.9;
        }
        .test-btn:active {
            transform: scale(0.96);
        }
        
        .volume-display {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
        }

        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem 1rem 8rem 1rem; /* Padding bottom for controls */
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .top-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .progress-container {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .progress-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .progress-svg circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        .progress-bg { stroke: var(--surface); }
        .progress-bar {
            stroke: var(--primary-accent);
            transition: stroke-dashoffset 1s linear;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 700;
        }
        .progress-value {
            font-size: 1.75rem;
            color: var(--primary-text);
        }
        .progress-label {
            font-size: 0.7rem;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .time-summary {
            font-size: 0.9rem;
            color: var(--secondary-text);
            text-align: left;
            line-height: 1.8;
            min-width: 160px;
        }
        .time-summary strong {
            color: var(--primary-text);
            font-weight: 500;
            float: right;
            margin-left: 1rem;
        }

        .exercise-info h1 {
            font-size: clamp(1.5rem, 5vw, 2.25rem);
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .exercise-info h2 {
            font-size: clamp(1rem, 3vw, 1.25rem);
            font-weight: 400;
            color: var(--primary-accent);
            margin-bottom: 0.5rem;
            min-height: 1.25em;
        }

        .exercise-info p {
            color: var(--secondary-text);
            font-size: 0.9rem;
        }
        
        .exercise-timer {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 1.5rem 0;
        }
        
        .exercise-timer .progress-value {
            font-size: 4rem;
        }
        .exercise-timer .progress-label {
            font-size: 1rem;
        }

        .exercise-meta {
            color: var(--secondary-text);
        }
        
        .details-toggle {
            color: var(--primary-accent);
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 0.5rem;
            display: inline-block;
            font-size: 0.9rem;
            padding: 0.25rem 0;
        }

        .details-toggle:hover {
            opacity: 0.8;
        }

        .exercise-details {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            display: none;
            color: var(--secondary-text);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .exercise-details.visible {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .exercise-details h4 {
            color: var(--primary-text);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .exercise-details p {
            margin-bottom: 0.75rem;
        }

        .exercise-details p:last-child {
            margin-bottom: 0;
        }

        #next-exercise-text {
            min-height: 1.2em;
        }

        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .controls button {
            background: transparent;
            color: var(--primary-text);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            width: 72px;
            height: 72px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .controls button#playPauseBtn {
            width: 80px;
            height: 80px;
            background-color: var(--primary-accent);
            color: var(--bg-dark);
            border: none;
            border-radius: 20px;
        }
        
        .controls button:hover:not(:disabled) {
            background-color: var(--surface);
            border-color: var(--secondary-text);
            transform: translateY(-2px);
        }
        .controls button#playPauseBtn:hover:not(:disabled) {
            background-color: var(--primary-accent);
            opacity: 0.9;
            transform: translateY(-2px) scale(1.05);
        }

        .controls button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .controls button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .complete-screen {
            padding: 2rem;
        }
        .complete-screen h2 {
            font-size: 2.5rem;
            color: #4ade80; /* A nice green */
            margin-bottom: 1rem;
        }

        .btn-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 0.2rem;
            text-align: center;
        }
        
        .btn-label {
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .material-symbols-outlined {
            font-size: 1.8rem;
            line-height: 1;
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .controls button#playPauseBtn .material-symbols-outlined {
            font-size: 2.2rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add Material Symbols font -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-title">Elite Post-Run Stretch</div>
        <div class="header-controls">
            <button class="test-btn" onclick="testAudio()">ðŸ”Š Test</button>
            <span id="volumeDisplay" class="volume-display">90%</span>
        </div>
    </header>

    <main class="main-container" id="app-view">
        <!-- JS will populate this view -->
    </main>
    
    <div class="controls">
        <button onclick="previousExercise()" id="prevBtn" disabled aria-label="Previous Exercise">
            <span class="btn-content">
                <span class="material-symbols-outlined">skip_previous</span>
                <span class="btn-label">Prev</span>
            </span>
        </button>
        <button onclick="togglePlayPause()" id="playPauseBtn" aria-label="Play/Pause">
            <span class="btn-content">
                <span class="material-symbols-outlined" id="playPauseIcon">play_arrow</span>
                <span class="btn-label" id="playPauseLabel">Play</span>
            </span>
        </button>
        <button onclick="skipExercise()" id="skipBtn" disabled aria-label="Skip Exercise">
            <span class="btn-content">
                <span class="material-symbols-outlined">skip_next</span>
                <span class="btn-label">Next</span>
            </span>
        </button>
    </div>

    <script>
    const routine = [
        
    { "type": "note", "name": "TIMING NOTE:", "details": "This routine is best performed immediately after a 5-10 minute cool-down walk following your run. If there's a 20-min+ gap, do a 3-5 min light re-warm-up before starting.", "duration": 5, "voice": "Welcome to your condensed post-run stretching routine. This is best performed after a cool-down walk. Let's begin!" },
    { "name": "Deep Squat Hold (Malasana)", "details": "1. Stand with feet slightly wider than hip-width, toes pointing slightly outwards. 2. Lower your hips down as low as comfortable. 3. Keep your chest up and spine straight.", "duration": 15, "affected": "Hips, Glutes, Groin, Ankles, Lower Back", "dos": "Keep spine long, chest open. Breathe deeply.", "donts": "Don't round your back excessively. Don't force the depth.", "info": "Opens hips, improves ankle mobility.", "voice": "Starting with a Deep Squat Hold for 15 seconds. Keep your spine long." },
    { "name": "Deep Squat with Adductor Push", "details": "1. From Deep Squat, bring palms together. 2. Press your elbows against the inside of your knees, gently pushing them outwards.", "duration": 20, "affected": "Adductors (Inner Thighs), Hips, Groin", "dos": "Actively press elbows into knees. Keep chest lifted.", "donts": "Don't let your back round.", "info": "Deepens inner thigh and groin stretch.", "voice": "Now, add the Adductor Push. Press elbows into your knees. Hold for 20 seconds." },
    { "type": "break", "name": "Transition Break", "duration": 5, "voice": "Quick transition. Prepare for 90/90 Hip Stretch." },
    { "name": "90/90 Hip Stretch (Side 1)", "details": "1. Sit on the floor. Bend one leg in front (shin parallel to pelvis) and the other behind, both at 90-degree angles. 2. Keep sit bones down and lean forward over the front shin.", "duration": 15, "affected": "Hips (internal and external rotators), Glutes", "dos": "Maintain 90-degree angles. Breathe into the stretch.", "donts": "Don't force your knees if there's pain.", "info": "Improves hip mobility.", "voice": "90/90 Hip Stretch, first side. Hold for 15 seconds." },
    { "name": "90/90 Hip Stretch (Side 2)", "details": "Switch sides and repeat.", "duration": 15, "affected": "Hips (internal and external rotators), Glutes", "dos": "Maintain 90-degree angles. Breathe into the stretch.", "donts": "Don't force your knees if there's pain.", "info": "Improves hip mobility.", "voice": "Switch sides for 90/90 Hip Stretch. Hold for 15 seconds." },
    { "type": "break", "name": "Transition Break", "duration": 5, "voice": "Transition break. Prepare for Deep Squat to Toe Touch." },
    { "name": "Deep Squat to Toe Touch (Hamstring Stretch)", "details": "1. Squat down, hands under toes. 2. Keeping hands anchored, lift your hips towards the sky, straightening legs. 3. Lower back to squat. Repeat 2-3 times.", "duration": 35, "affected": "Hamstrings, Calves, Lower Back, Glutes", "dos": "Exhale as you lift hips. Keep hands anchored.", "donts": "Don't lock your knees or bounce.", "info": "Dynamic stretch for posterior chain.", "voice": "Deep Squat to Toe Touch. 2 to 3 slow repetitions over 35 seconds." },
    { "type": "break", "name": "Transition Break", "duration": 10, "voice": "Break. Prepare for Downward Dog." },
    { "name": "Downward Dog with Calf Pedals (Parvatasana)", "details": "1. From hands and knees, lift hips up and back into an inverted V. 2. For 15 seconds, gently 'pedal' your feet, bending one knee then the other. 3. Then, hold a deep stretch with your right heel down for 10 seconds. 4. Finally, hold a deep stretch with your left heel down for 10 seconds.", "duration": 40, "affected": "Calves, Hamstrings, Shoulders, Back", "dos": "Spread fingers wide, press through palms. Keep head relaxed.", "donts": "Don't let shoulders shrug up to ears.", "info": "Stretches the entire back of the body.", "voice": "Downward Dog. Pedal your calves for 15 seconds. Now, hold the right heel down for 10. Now, hold the left heel down for 10." },
    { "type": "break", "name": "Break & Transition", "duration": 10, "voice": "Break. Transition to standing for Calf Raises." },
    { "name": "Standing Calf Raises", "details": "1. Stand tall, using a wall for balance if needed. 2. Slowly rise up onto the balls of your feet, then slowly lower. Perform 8-12 reps.", "duration": 30, "affected": "Calves, Ankles", "dos": "Control the movement both up and down.", "donts": "Don't bounce.", "info": "Strengthens calves.", "voice": "Optional: Standing Calf Raises. 8 to 12 controlled reps over 30 seconds." },
    { "name": "Ankle Circles", "details": "1. Lift one foot and rotate the ankle in large, controlled circles. 2. Do 8-10 circles each direction, then switch feet.", "duration": 30, "affected": "Ankle Joint", "dos": "Make large, controlled circles.", "donts": "Don't rush the movement.", "info": "Improves ankle mobility.", "voice": "Optional: Ankle Circles. 15 seconds per foot, switching direction halfway." },
    { "type": "break", "name": "Break & Transition", "duration": 15, "voice": "Longer break. Prepare for World's Greatest Stretch." },
    { "name": "World's Greatest Stretch (Side 1)", "details": "1. From a plank, step left foot outside left hand. 2. Perform 2 cycles: Inhale and lift left arm to the sky, then exhale and bring left elbow towards the floor.", "duration": 60, "affected": "Hip Flexors, Hamstrings, Glutes, Groin, Thoracic Spine", "dos": "Sync breath with movement. Rotate from mid-back.", "donts": "Don't let front knee go past ankle.", "info": "Full-body dynamic stretch.", "voice": "World's Greatest Stretch, first side. 2 slow cycles of rotation over 60 seconds." },
    { "name": "World's Greatest Stretch (Side 2)", "details": "Switch legs and repeat on the other side. Perform 2 cycles.", "duration": 60, "affected": "Hip Flexors, Hamstrings, Glutes, Groin, Thoracic Spine", "dos": "Sync breath with movement. Rotate from mid-back.", "donts": "Don't let front knee go past ankle.", "info": "Full-body dynamic stretch.", "voice": "Switch sides for World's Greatest Stretch. 2 more slow cycles." },
    { "type": "break", "name": "Break & Transition", "duration": 10, "voice": "Break. Prepare for Kneeling Hip Flexor Stretch." },
    { "name": "Kneeling Hip Flexor Stretch (Side 1)", "details": "1. Kneel on one knee, other foot forward (knee over ankle). 2. Tuck tailbone under and gently shift hips forward. Raise the arm on the kneeling side for a deeper stretch.", "duration": 20, "affected": "Hip Flexors, Quadriceps", "dos": "Maintain an upright torso. Engage glutes on the back leg side.", "donts": "Don't arch your lower back.", "info": "Targets deep hip flexors.", "voice": "Kneeling Hip Flexor Stretch, first side. Tuck your tailbone. Hold for 20 seconds." },
    { "name": "Kneeling Hip Flexor Stretch (Side 2)", "details": "Switch sides.", "duration": 20, "affected": "Hip Flexors, Quadriceps", "dos": "Maintain an upright torso. Engage glutes on the back leg side.", "donts": "Don't arch your lower back.", "info": "Targets deep hip flexors.", "voice": "Switch sides for Kneeling Hip Flexor Stretch. Hold for 20 seconds." },
    { "type": "break", "name": "Break & Transition", "duration": 15, "voice": "Break. Prepare for Pigeon Pose." },
    { "name": "Pigeon Pose Prep (Side 1)", "details": "1. From hands and knees, bring left knee forward behind left wrist. 2. Extend right leg straight back. Keep hips square. 3. Stay upright for 10 seconds, then fold forward over your front leg.", "duration": 60, "affected": "Glutes (piriformis), Hip Flexors", "dos": "Keep hips level. Use props if needed.", "donts": "Avoid pain in the knee of the bent leg.", "info": "Deep hip opener.", "voice": "Pigeon Pose, first side. Stay upright for 10 seconds, then fold forward for the rest. Breathe." },
    { "name": "Pigeon Pose Prep (Side 2)", "details": "Switch sides.", "duration": 60, "affected": "Glutes (piriformis), Hip Flexors", "dos": "Keep hips level. Use props if needed.", "donts": "Avoid pain in the knee of the bent leg.", "info": "Deep hip opener.", "voice": "Switch sides for Pigeon Pose. Upright for 10 seconds, then fold forward. Keep hips square." },
    { "type": "break", "name": "Break & Transition", "duration": 10, "voice": "Break. Prepare for Plantar Fascia Stretch." },
    { "name": "Plantar Fascia & Toe Stretch", "details": "1. Kneel, tuck toes under, and sit back on your heels. Or sit and pull the toes of one foot back towards the shin. 2. Hold the stretch on the sole of your foot.", "duration": 40, "affected": "Plantar Fascia, Toes", "dos": "Be gentle. Feel the stretch along the arch.", "donts": "Don't pull aggressively.", "info": "Helps prevent plantar fasciitis.", "voice": "Plantar Fascia and Toe Stretch. Hold for 40 seconds. If doing one foot at a time, switch halfway." },
    { "type": "break", "name": "Break & Transition", "duration": 10, "voice": "Transition to all fours for Cat-Camel." },
    { "name": "Cat-Camel Stretch (Marjaryasana-Bitilasana)", "details": "1. On all fours, exhale and round your spine up (Camel). 2. Inhale, drop your belly and arch your back (Cat). 3. Flow smoothly between the two for 4-5 repetitions.", "duration": 40, "affected": "Spine, Core, Back Muscles", "dos": "Coordinate movement with breath. Move through the entire spine.", "donts": "Don't force the range of motion.", "info": "Improves spinal flexibility.", "voice": "Cat-Camel Stretch. Flow with your breath for 40 seconds." },
    { "name": "Bird-Dog", "details": "1. From all fours, extend your right arm forward and left leg back. 2. Hold briefly, then return to start. Alternate sides. Perform 4-6 slow reps per side.", "duration": 60, "affected": "Core, Glutes, Shoulders, Back Stabilizers", "dos": "Keep your core engaged and back flat. Move with control.", "donts": "Don't let your lower back sag.", "info": "Improves core stability and balance.", "voice": "Optional: Bird-Dog. Alternate sides with control for 60 seconds." },
    { "type": "break", "name": "Transition to lying on your stomach.", "duration": 10, "voice": "Lie on your stomach for Cobra and Child's Pose." },
    { "name": "Cobra & Child's Pose Flow", "details": "1. (Cobra) Inhale, lift chest off floor. 2. (Child's Pose) Exhale, push hips back to heels. 3. Flow between the two poses, holding each for about 10-15 seconds. Do 2 full cycles.", "duration": 60, "affected": "Spine, Chest, Abdominals, Lower Back, Hips", "dos": "Cobra: Keep hips on floor. Child: Relax completely.", "donts": "Cobra: Don't overarch lower back.", "info": "Strengthens back, stretches chest, restorative.", "voice": "Flow between Cobra and Child's Pose. 2 full cycles over 60 seconds." },
    { "type": "break", "name": "Break & Transition", "duration": 10, "voice": "Break. Transition to a seated position." },
    { "name": "Arm & Shoulder Stretch Series", "details": "1. Arm Across Chest (20s right, 20s left). 2. Overhead Triceps Stretch (20s right, 20s left).", "duration": 80, "affected": "Shoulders, Upper Back, Triceps", "dos": "Keep shoulders relaxed and down. Breathe.", "donts": "Don't pull on the elbow joint.", "info": "Quick upper body release.", "voice": "Seated Arm Stretches. First, Arm Across Chest, 20 seconds each side. ... Now, Overhead Triceps Stretch, 20 seconds each side." },
    { "name": "Neck Stretch Series", "details": "1. Neck Side Stretch (12s right, 12s left). 2. Neck Forward Diagonal Stretch (15s right, 15s left).", "duration": 54, "affected": "Neck, Upper Trapezius", "dos": "Stretch gently. Keep shoulders relaxed.", "donts": "Don't pull hard on your head.", "info": "Releases neck tension.", "voice": "Neck Stretches. First, side stretch, 12 seconds each way. ... Now, diagonal stretch, chin to collarbone, 15 seconds each way." },
    { "type": "break", "name": "Break & Transition", "duration": 5, "voice": "Prepare for the final stretch." },
    { "name": "Rabbit Pose (Sasangasana Variation)", "details": "1. Kneel, sitting on heels. Clasp hands behind your back. 2. Exhale, fold forward, bringing forehead towards the floor. 3. Lift clasped hands up towards the ceiling.", "duration": 45, "affected": "Shoulders, Chest, Upper Back, Spine", "dos": "Let gravity assist the arm stretch.", "donts": "Avoid if severe shoulder/neck issues.", "info": "Deep shoulder and chest opener.", "voice": "Final stretch: Rabbit Pose. Fold forward and lift your arms. Hold for 45 seconds." },
    { "type": "note", "name": "Cool Down Complete", "details": "Take a few deep, relaxing breaths. Hydrate well! Great job completing your condensed post-run routine.", "duration": 10, "voice": "Stretching complete! Fantastic work. Take a few deep breaths and remember to hydrate well. You've earned it." }

    ];

    // Global state
    let currentExerciseIndex = 0;
    let exerciseTimer;
    let timeSpentInCurrent = 0;
    let isPlaying = false;
    let isPaused = false;
    const synth = window.speechSynthesis;
    
    // UI Elements
    const appView = document.getElementById('app-view');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const skipBtn = document.getElementById('skipBtn');

    // Utility Functions
    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const calculateTotalTime = () => routine.reduce((total, item) => total + (item.duration || 0), 0);

    // Speech Synthesis
    const speak = (text) => {
        if (!text) return;
        if (synth.speaking) synth.cancel();
        setTimeout(() => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = 0.9;
            utterance.rate = 0.95;
            synth.speak(utterance);
        }, 150);
    };

    const testAudio = () => speak("Audio test successful.");
    
    // Progress Circle Updater
    const updateCircularProgress = (circleElement, percentage) => {
        if (!circleElement) return;
        const radius = circleElement.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;
        circleElement.style.strokeDasharray = `${circumference} ${circumference}`;
        circleElement.style.strokeDashoffset = offset;
    };

    // Main Display Logic
    const displayExercise = (index) => {
        if (index >= routine.length) {
            completeRoutine();
            return;
        }
        
        const item = routine[index];
        const isBreak = item.type === 'break';
        const isNote = item.type === 'note';
        
        let name = item.name;
        let subtitle = '';
        const subtitleMatch = name.match(/\(([^)]+)\)/);
        if (subtitleMatch) {
            subtitle = subtitleMatch[0];
            name = name.replace(subtitleMatch[0], '').trim();
        }

        const nextItem = index + 1 < routine.length ? routine[index + 1] : null;

        // Create details content if available
        let detailsContent = '';
        if (item.details || item.affected || item.dos || item.donts || item.info) {
            detailsContent = `
                <div class="exercise-details" id="exercise-details">
                    ${item.details ? `<h4>Instructions:</h4><p>${item.details}</p>` : ''}
                    ${item.affected ? `<h4>Muscles Affected:</h4><p>${item.affected}</p>` : ''}
                    ${item.dos ? `<h4>Do's:</h4><p>${item.dos}</p>` : ''}
                    ${item.donts ? `<h4>Don'ts:</h4><p>${item.donts}</p>` : ''}
                    ${item.info ? `<h4>Benefits:</h4><p>${item.info}</p>` : ''}
                </div>
            `;
        }

        appView.innerHTML = `
            <div class="top-info">
                <div class="progress-container">
                    <svg class="progress-svg" viewBox="0 0 100 100">
                        <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="progress-bar" id="overall-progress-bar" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="progress-text">
                        <span class="progress-value" id="overall-progress-value">0%</span>
                        <div class="progress-label">Overall</div>
                    </div>
                </div>
                <div class="time-summary">
                    <div>Total Time Spent<strong id="total-time-spent">0:00</strong></div>
                    <div>Total Time Left<strong id="total-time-left">0:00</strong></div>
                </div>
            </div>

            <div class="exercise-info">
                <h1>${name}</h1>
                <h2>${subtitle}</h2>
                <p>${(isBreak || isNote) ? '' : `Duration: ${item.duration} seconds`}</p>
            </div>
            
            <div class="exercise-timer progress-container">
                 <svg class="progress-svg" viewBox="0 0 100 100">
                    <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
                    <circle class="progress-bar" id="exercise-progress-bar" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="progress-text">
                    <span class="progress-value" id="exercise-time-left">${item.duration}</span>
                    <div class="progress-label">Seconds</div>
                </div>
            </div>

            <div class="exercise-meta">
                ${detailsContent ? `<a class="details-toggle" onclick="toggleDetails()">Show Details</a>` : ''}
                ${detailsContent}
                <p id="next-exercise-text">
                    ${nextItem ? `Next: ${nextItem.name}` : ''}
                </p>
            </div>
        `;
        
        if (item.voice && isPlaying) speak(item.voice);
        updateAllUI();
    };

    // Toggle details function
    const toggleDetails = () => {
        const details = document.getElementById('exercise-details');
        const toggle = document.querySelector('.details-toggle');
        if (details && toggle) {
            if (details.classList.contains('visible')) {
                details.classList.remove('visible');
                toggle.textContent = 'Show Details';
            } else {
                details.classList.add('visible');
                toggle.textContent = 'Hide Details';
            }
        }
    };
    
    // UI Update Functions
    const updateAllUI = () => {
        if (currentExerciseIndex >= routine.length) return;
        
        const totalTime = calculateTotalTime();
        
        let timeElapsedSoFar = 0;
        for (let i = 0; i < currentExerciseIndex; i++) {
            timeElapsedSoFar += routine[i].duration;
        }
        const totalTimeElapsed = timeElapsedSoFar + timeSpentInCurrent;
        const totalTimeLeft = totalTime - totalTimeElapsed;

        // Overall Progress
        const overallPercentage = totalTime > 0 ? (totalTimeElapsed / totalTime) * 100 : 0;
        updateCircularProgress(document.getElementById('overall-progress-bar'), overallPercentage);
        document.getElementById('overall-progress-value').textContent = `${Math.round(overallPercentage)}%`;
        
        // Time Summary
        document.getElementById('total-time-spent').textContent = formatTime(totalTimeElapsed);
        document.getElementById('total-time-left').textContent = formatTime(totalTimeLeft);

        // Exercise Timer
        const currentDuration = routine[currentExerciseIndex].duration;
        const exercisePercentage = currentDuration > 0 ? (timeSpentInCurrent / currentDuration) * 100 : 0;
        updateCircularProgress(document.getElementById('exercise-progress-bar'), exercisePercentage);
        document.getElementById('exercise-time-left').textContent = Math.round(currentDuration - timeSpentInCurrent);
        
        updateControls();
    };

    const updateControls = () => {
        const isFirst = currentExerciseIndex === 0;
        const isLast = currentExerciseIndex >= routine.length - 1;
        // Enable prev if not first and routine not complete
        prevBtn.disabled = !isPlaying || isFirst || currentExerciseIndex >= routine.length;
        // Enable skip if not last and routine not complete
        skipBtn.disabled = !isPlaying || isLast || currentExerciseIndex >= routine.length;
        // Play/Pause button should be enabled unless routine is complete
        playPauseBtn.disabled = currentExerciseIndex >= routine.length;
    };
    
    // Timer Logic
    const startTimer = () => {
        if (currentExerciseIndex >= routine.length) return;
        
        const currentItem = routine[currentExerciseIndex];
        const totalDuration = currentItem.duration;
        let halfAnnounced = false;
        
        clearInterval(exerciseTimer);
        exerciseTimer = setInterval(() => {
            if (isPaused) return;

            timeSpentInCurrent++;
            updateAllUI();
            
            // Halfway announcement
            if (!halfAnnounced && totalDuration > 15 && timeSpentInCurrent >= Math.floor(totalDuration / 2)) {
                if (/Side 1/i.test(currentItem.name)) {
                    speak('Halfway there. Get ready to switch sides.');
                } else {
                   speak('Halfway there.');
                }
                halfAnnounced = true;
            }

            if (timeSpentInCurrent >= totalDuration) {
                clearInterval(exerciseTimer);
                currentExerciseIndex++;
                timeSpentInCurrent = 0;
                displayExercise(currentExerciseIndex);
                if(isPlaying) startTimer();
            }
        }, 1000);
    };

    // Control Actions
    const skipExercise = (isPrev = false) => {
        clearInterval(exerciseTimer);
        currentExerciseIndex += isPrev ? -1 : 1;
        timeSpentInCurrent = 0;
        if (currentExerciseIndex < 0) currentExerciseIndex = 0;
        if (currentExerciseIndex >= routine.length) {
            completeRoutine();
            return;
        }
        displayExercise(currentExerciseIndex);
        if (isPlaying && !isPaused) startTimer();
    };

    const previousExercise = () => skipExercise(true);

    const updatePlayPauseBtn = () => {
        const icon = document.getElementById('playPauseIcon');
        const label = document.getElementById('playPauseLabel');
        if (!isPlaying) {
            if (icon) icon.textContent = 'play_arrow';
            if (label) label.textContent = 'Play';
        } else if (isPaused) {
            if (icon) icon.textContent = 'play_arrow';
            if (label) label.textContent = 'Resume';
        } else {
            if (icon) icon.textContent = 'pause';
            if (label) label.textContent = 'Pause';
        }
    };

    const togglePlayPause = () => {
        if (!isPlaying) {
            isPlaying = true;
            isPaused = false;
            updatePlayPauseBtn();
            displayExercise(currentExerciseIndex);
            startTimer();
        } else {
            isPaused = !isPaused;
            updatePlayPauseBtn();
            if (isPaused) {
                synth.pause();
            } else {
                synth.resume();
            }
        }
        updateControls();
    };

    const completeRoutine = () => {
        isPlaying = false;
        isPaused = false;
        clearInterval(exerciseTimer);
        appView.innerHTML = `
            <div class="complete-screen">
                <h2>Routine Complete!</h2>
                <p>Great work taking care of your body. Remember to hydrate and recover well.</p>
                <button class="test-btn" id="restartBtn">Restart</button>
            </div>
        `;
        playPauseBtn.disabled = true;
        prevBtn.disabled = true;
        skipBtn.disabled = true;
        speak("Congratulations! You have completed the stretching routine. Great work!");
        // Add restart functionality
        setTimeout(() => {
            const restartBtn = document.getElementById('restartBtn');
            if (restartBtn) {
                restartBtn.onclick = function() {
                    currentExerciseIndex = 0;
                    timeSpentInCurrent = 0;
                    isPlaying = false;
                    isPaused = false;
                    playPauseBtn.disabled = false;
                    updatePlayPauseBtn();
                    displayExercise(currentExerciseIndex);
                };
            }
        }, 100);
    };
    
    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        updatePlayPauseBtn();
        displayExercise(currentExerciseIndex);
    });
    </script>
</body>
</html>